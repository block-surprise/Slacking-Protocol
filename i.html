<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サボり・プロトコル | NATIVE AUDIO v4.0</title>
    <style>
        :root { --primary: #00f2fe; --danger: #ff3b30; --bg: #050510; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Courier New', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 450px; padding: 30px; background: rgba(10, 10, 30, 0.9); backdrop-filter: blur(20px); border: 2px solid var(--primary); border-radius: 5px; text-align: center; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border: 1px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; font-size: 0.8rem; }
        .mode-btn.active { background: var(--primary); color: var(--bg); font-weight: bold; }
        textarea { width: 100%; height: 100px; background: #000; border: 1px solid var(--primary); color: var(--primary); padding: 15px; box-sizing: border-box; margin-bottom: 20px; outline: none; }
        button#main-btn { width: 100%; padding: 18px; background: transparent; border: 2px solid var(--primary); color: var(--primary); font-weight: bold; cursor: pointer; overflow: hidden; position: relative; }
        button#main-btn:disabled { opacity: 0.3; }
        .score-display { font-size: 5rem; font-weight: 900; text-shadow: 0 0 20px var(--primary); margin: 20px 0; }
        .comment { font-size: 0.9rem; padding: 15px; background: rgba(255,255,255,0.05); border-left: 4px solid var(--primary); text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div class="mode-selector">
        <button id="mode-cool" class="mode-btn active" onclick="setMode('cool')">冷徹解析</button>
        <button id="mode-kind" class="mode-btn" onclick="setMode('kind')">慈愛聖母</button>
        <button id="mode-army" class="mode-btn" onclick="setMode('army')">鬼軍曹</button>
    </div>

    <h1>PROTOCOL: SABORI</h1>
    <textarea id="reason" placeholder="未達成事由（言い訳）を入力..."></textarea>
    <button id="main-btn" onclick="startBattle()">解析プロトコル実行</button>

    <div id="resultArea" style="display:none;">
        <div id="score" class="score-display">0%</div>
        <div id="comment" class="comment"></div>
    </div>
</div>

<script>
    const WORKER_URL = 'https://iiwake.proluce.workers.dev';
    let currentMode = 'cool';

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`mode-${mode}`).classList.add('active');
    }

    async function startBattle() {
        const reason = document.getElementById('reason').value;
        if (!reason) return;

        const btn = document.getElementById('main-btn');
        btn.disabled = true;
        btn.innerText = "CONNECTING AI...";
        document.getElementById('resultArea').style.display = 'block';

        try {
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason, mode: currentMode })
            });
            const data = await response.json();
            
            animateScore(data.score, data.comment);
        } catch (e) {
            alert("通信エラー。システムを再起動してください。");
            btn.disabled = false;
        }
    }

    function animateScore(target, commentText) {
        let current = 0;
        const timer = setInterval(() => {
            if (current >= target) {
                clearInterval(timer);
                document.getElementById('comment').innerText = commentText;
                speak(commentText);
                document.getElementById('main-btn').disabled = false;
                document.getElementById('main-btn').innerText = "解析プロトコル実行";
            } else {
                current += 2;
                if(current > target) current = target;
                document.getElementById('score').innerText = current + "%";
            }
        }, 30);
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP';
        
        // モードごとに声のトーンを極端に変える
        if (currentMode === 'kind') { uttr.pitch = 1.4; uttr.rate = 0.8; }
        else if (currentMode === 'army') { uttr.pitch = 0.5; uttr.rate = 1.5; }
        else { uttr.pitch = 0.7; uttr.rate = 1.0; }
        
        window.speechSynthesis.speak(uttr);
    }
</script>

</body>
</html>
